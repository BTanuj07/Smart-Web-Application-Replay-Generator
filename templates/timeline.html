{% extends "base.html" %}

{% block title %}Timeline View - AttackReplay Pro{% endblock %}

{% block page_title %}Timeline Analytics{% endblock %}
{% block page_description %}Historical attack trends and patterns{% endblock %}

{% block header_actions %}
{% if timeline_data %}
<div class="btn-group">
    <button class="btn btn-outline-primary" onclick="refreshTimeline()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <button class="btn btn-outline-success" onclick="exportTimelineData()">
        <i class="fas fa-download"></i> Export Data
    </button>
</div>
{% endif %}
{% endblock %}

{% block content %}
{% if not db_available %}
<!-- Database Unavailable -->
<div class="row">
    <div class="col-12">
        <div class="card text-center">
            <div class="card-body py-5">
                <div class="feature-icon mx-auto mb-4" style="background: var(--secondary-color); color: var(--text-secondary);">
                    <i class="fas fa-database"></i>
                </div>
                <h4 class="mb-3">Database Required</h4>
                <p class="text-muted mb-4">Timeline visualization requires database connection to track attack patterns across multiple analysis sessions.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Once the database is configured, you'll see historical trends and attack patterns here.
                </div>
            </div>
        </div>
    </div>
</div>

{% elif timeline_data %}

<!-- Timeline Statistics -->
<div class="row mb-4">
    {% set total_attacks = timeline_data|sum(attribute='attacks') %}
    {% set total_ips = timeline_data|sum(attribute='unique_ips') %}
    {% set avg_attacks = (total_attacks / timeline_data|length)|round(1) if timeline_data|length > 0 else 0 %}
    
    <div class="col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-number text-danger">{{ total_attacks }}</div>
            <div class="stats-label">Total Attacks (30 Days)</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-number text-warning">{{ total_ips }}</div>
            <div class="stats-label">Total Unique IPs</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-number text-info">{{ avg_attacks }}</div>
            <div class="stats-label">Avg Attacks/Day</div>
        </div>
    </div>
</div>

<!-- Timeline Charts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i> Attacks Over Time (Last 30 Days)
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
                    <canvas id="attacksTimelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-globe"></i> Unique Attacking IPs Over Time
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
                    <canvas id="ipsTimelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Analysis History -->
{% if history %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history"></i> Analysis History
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th class="text-center">Attacks</th>
                                <th class="text-center">Unique IPs</th>
                                <th class="text-center">Log Lines</th>
                                <th>Analyzed At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in history %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-alt text-primary me-2"></i>
                                        <code class="bg-light p-1 rounded">{{ record.filename }}</code>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-danger">{{ record.total_attacks }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning">{{ record.unique_ips }}</span>
                                </td>
                                <td class="text-center">
                                    {{ "{:,}".format(record.total_lines) }}
                                </td>
                                <td>
                                    <small class="text-muted">{{ record.analyzed_at }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- No Data State -->
<div class="row">
    <div class="col-12">
        <div class="card text-center">
            <div class="card-body py-5">
                <div class="feature-icon mx-auto mb-4" style="background: var(--secondary-color); color: var(--text-secondary);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h4 class="mb-3">No Historical Data Available</h4>
                <p class="text-muted mb-4">Analyze some log files to see timeline visualization and attack trends.</p>
                <a href="{{ url_for('upload_analyze') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-upload"></i> Upload & Analyze Log Files
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Information Cards -->
<div class="row mt-4">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-info-circle"></i> Timeline Features
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            <div>
                                <strong>Trend Analysis</strong>
                                <br><small class="text-muted">Track attack patterns over time</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-search text-success me-2"></i>
                            <div>
                                <strong>Pattern Detection</strong>
                                <br><small class="text-muted">Identify recurring attack campaigns</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-globe text-info me-2"></i>
                            <div>
                                <strong>IP Monitoring</strong>
                                <br><small class="text-muted">Track unique attacking sources</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-database text-warning me-2"></i>
                            <div>
                                <strong>Historical Storage</strong>
                                <br><small class="text-muted">Persistent analysis data</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb"></i> Security Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <div>
                                <strong>Attack Spikes</strong>
                                <br><small class="text-muted">Identify peak attack periods</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-shield-alt text-success me-2"></i>
                            <div>
                                <strong>Security Effectiveness</strong>
                                <br><small class="text-muted">Monitor defense improvements</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-crosshairs text-primary me-2"></i>
                            <div>
                                <strong>Threat Correlation</strong>
                                <br><small class="text-muted">Link IP patterns with attack types</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-alt text-info me-2"></i>
                            <div>
                                <strong>Strategic Planning</strong>
                                <br><small class="text-muted">Plan security measures based on trends</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if timeline_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const timelineData = JSON.parse('{{ timeline_data|tojson|safe }}');
    
    // Prepare data for charts
    const dates = timelineData.map(item => item.date);
    const attacks = timelineData.map(item => item.attacks);
    const uniqueIps = timelineData.map(item => item.unique_ips);
    
    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1
            }
        },
        interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    };
    
    // Attacks Timeline Chart
    const attacksCtx = document.getElementById('attacksTimelineChart').getContext('2d');
    const attacksChart = new Chart(attacksCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Total Attacks',
                data: attacks,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Attacks',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
    
    // Unique IPs Timeline Chart
    const ipsCtx = document.getElementById('ipsTimelineChart').getContext('2d');
    const ipsChart = new Chart(ipsCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Unique IPs',
                data: uniqueIps,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Unique IPs',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
    
    // Store chart references globally for refresh function
    window.timelineCharts = {
        attacks: attacksChart,
        ips: ipsChart
    };
});

// Refresh timeline data
function refreshTimeline() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    fetch('/api/timeline_data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update chart data
            const dates = data.map(item => item.date);
            const attacks = data.map(item => item.attacks);
            const uniqueIps = data.map(item => item.unique_ips);
            
            // Update attacks chart
            window.timelineCharts.attacks.data.labels = dates;
            window.timelineCharts.attacks.data.datasets[0].data = attacks;
            window.timelineCharts.attacks.update();
            
            // Update IPs chart
            window.timelineCharts.ips.data.labels = dates;
            window.timelineCharts.ips.data.datasets[0].data = uniqueIps;
            window.timelineCharts.ips.update();
            
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> Timeline data refreshed successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.content-body').insertBefore(alert, document.querySelector('.content-body').firstChild);
            
            // Auto-hide alert
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 3000);
        })
        .catch(error => {
            console.error('Error refreshing timeline:', error);
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> Error refreshing timeline: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.content-body').insertBefore(alert, document.querySelector('.content-body').firstChild);
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// Export timeline data
function exportTimelineData() {
    const timelineData = JSON.parse('{{ timeline_data|tojson|safe }}');
    
    // Create CSV content
    const csvContent = [
        ['Date', 'Total Attacks', 'Unique IPs'],
        ...timelineData.map(item => [item.date, item.attacks, item.unique_ips])
    ].map(row => row.join(',')).join('\n');
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `timeline_data_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-download"></i> Timeline data exported successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.content-body').insertBefore(alert, document.querySelector('.content-body').firstChild);
    
    // Auto-hide alert
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    }, 3000);
}
</script>
{% endif %}
{% endblock %}